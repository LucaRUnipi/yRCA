import os
import re
import sys

# function comparing the explanations generated by "explain.py" with
# with the "realTrace" produced by "post_process.py"
# (returns the index of the explanation corresponding to "realTrace",
# or -1 if there is no corresponding explanation)
def compareOutputs(explanationsPath,realTracePath):
    # creating a string denoting the "realTrace"
    realTraceFile = open(realTracePath, "r")
    trace = ""
    for rtLine in list(realTraceFile):
        trace += rtLine.replace("\n","")
    realTraceFile.close()

    # creating a list of strings, each corresponding to one of the possible
    # "explanations" found by "explain.py"
    explanationsFile = open(explanationsPath,"r")
    exp = ""
    exps = []
    for expLine in list(explanationsFile):
        # if finished parsing explanation, adding it to list of explanations
        if expLine=="\n":
            exps.append(exp)
            exp = ""
        # otherwise, continue parsing explanation
        else:
            # removing "[<probability>]", if any
            event = re.sub(r"\[\d+.\d+\]: ","",expLine).replace("\n","")
            # adding event to explanation
            exp += event.replace("\n","")
    explanationsFile.close()

    # returning the index of the real trace in the list of found explanations
    try:
        return exps.index(trace)
    # or -1, otherwise
    except:
        return -1

if __name__ == "__main__":
    # get absolute path of explainer
    explainer = os.path.abspath("../../../../explain.py")

    # get absolute path of folder with logs
    logFolder = os.path.abspath("../generated-logs")

    # process log subfolders, separately
    subfolders = os.listdir(logFolder)
    for subfolder in subfolders:
        # get logfiles in subfolder
        logSubfolder = os.path.join(logFolder,subfolder)
        logFiles = os.listdir(logSubfolder)

        # process each log file, separately
        for file in logFiles:
            logFile = os.path.join(logSubfolder,file)
            
            # process each failure event of the frontend, separately
            cmd = "grep ERROR " + logFile + " | grep _edgeRouter"
            failures = os.popen(cmd)
            for failure in list(failures):
                # generate JSON file containing the failure to explain 
                failureJSON = open("failure","w")
                failureJSON.write(failure)
                failureJSON.close()

                # process failure file with "explain.py"
                # TODO

                # process failure file with "print_trace.py"
                # TODO

                # compare outputs and store them in CSV file
                # expIndex = compareOutputs(explanations,realTrace)
                # TODO